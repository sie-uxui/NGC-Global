ACC.autocomplete = {

	_autoload: [
		"bindSearchAutocomplete",
		"bindDisableSearch"
	],

	bindSearchAutocomplete: function ()
	{
		// extend the default autocomplete widget, to solve issue on multiple instances of the searchbox component
		$.widget( "custom.yautocomplete", $.ui.autocomplete, {
			_create:function(){

				// get instance specific options form the html data attr
				var option = this.element.data("options");
				// set the options to the widget
				this._setOptions({
					minLength: option.minCharactersBeforeRequest,
					displayProductImages: option.displayProductImages,
					delay: option.waitTimeBeforeRequest,
					autocompleteUrl: option.autocompleteUrl,
					source: this.source
				});

				// call the _super()
				$.ui.autocomplete.prototype._create.call(this);

			},
			options:{
				cache:{}, // init cache per instance
				focus: function (){return false;}, // prevent textfield value replacement on item focus
				select: function (event, ui){
					if (ui.item.type !== "mlfbCandidate"){
						ui.item.value = ACC.sanitizer.sanitize(ui.item.value, false);
						window.location.href = ui.item.url;
					}
				}
			},
			_renderItem : function (ul, item){
				if (item.type === "mlfbCandidate"){
                    const aButton = $("<a>" + $("#translation-pdp").text() + "</a>").addClass("autocomplete-result-btn")
                        .attr("href", item.url)
                        .attr("data-toggle", "tooltip")
                        .attr("title", $("#translation-pdp-mouseover").text());

                    var aInfo = $("<a>").addClass("glyphicon glyphicon-info-sign icon")
                        .attr("href", "#")
                        .attr("data-toggle", "tooltip")
                        .attr("title", "<p><b>" + item.value + "</b></p>");

                    aInfo.tooltip({
                        html:true,
                        content: function () {
                            return this.getAttribute("title");
                        }
                    });

                    var renderHtml = $("<div>").addClass("mlfb").addClass("config-result")
                        .append($("<div>").addClass("name").text('MLFB ' + item.mlfbPrefix))
                        .append(aInfo)
                        .append(aButton);
                    return $("<li>")
                        .data("item.autocomplete", item)
                        .append(renderHtml)
                        .appendTo(ul);
				}
                else if (item.type === "configCandidate") {
                    const aButton = $("<a>" + $("#translation-pdp").text() + "</a>").addClass("autocomplete-result-btn")
                        .attr("href", item.url)
                        .attr("data-toggle", "tooltip")
                        .attr("title", $("#translation-pdp-mouseover").text());

                    var renderHtml = $("<div>").addClass("mlfb").addClass("config-result")
                        .append($("<div>").addClass("name").text(item.value))
                        .append(aButton);

                    return $("<li>")
                        .data("item.autocomplete", item)
                        .append(renderHtml)
                        .appendTo(ul);
                }
				else if (item.type === "autoSuggestion"){
					var renderHtml = $("<a>").attr("href", item.url)
						.append($("<div>").addClass("name").text(item.value));
					return $("<li>")
						.data("item.autocomplete", item)
						.append(renderHtml)
						.appendTo(ul);
				}
				else if (item.type === "productResult"){
					var renderHtml = "<a href='" + item.url + "' >";

					if (item.image != null){
						renderHtml += "<div class='thumb'><img src='" + item.image + "'  /></div>";
					}

					renderHtml += 	"<div class='name'>" + item.value +"</div>";
					renderHtml += 	"<div class='price'>" + (!!item.price ? item.price : "") +"</div>";
					renderHtml += 	"</a>";

					return $("<li>").data("item.autocomplete", item).append(renderHtml).appendTo(ul);
				}
			},
			source: function (request, response)
			{
                $(".search-product-not-found").hide();
				var self=this;
				var term = request.term.toLowerCase();
				if (term in self.options.cache)
				{
					return response(self.options.cache[term]);
				}

				$.getJSON(self.options.autocompleteUrl, {term: request.term}, function (data)
				{
					var autoSearchData = [];
					if(data.mlfbCandidates != null){
						$.each(data.mlfbCandidates, function (i, obj)
						{
							autoSearchData.push({
								code: obj.code,
								mlfbPrefix: ACC.sanitizer.sanitize(obj.mlfbPrefix),
								url: ACC.config.encodedContextPath + obj.configUrl,
								value: ACC.sanitizer.sanitize(obj.searchTerm),
								type: "mlfbCandidate"
							});
						});
					}

                    if (data.configCandidates) {
                        $.each(data.configCandidates, function (i, obj) {
                            autoSearchData.push({
                                code: obj.code,
                                url:  ACC.config.encodedContextPath + obj.configUrl,
                                value: ACC.sanitizer.sanitize(obj.configId),
                                type: "configCandidate"
                            })
                        });
                    }

					if(data.suggestions != null){
						$.each(data.suggestions, function (i, obj)
						{
							autoSearchData.push({
								value: obj.term,
								url: ACC.config.encodedContextPath + "/search?text=" + encodeURIComponent(obj.term),
								type: "autoSuggestion"
							});
						});
					}

					if(data.products != null){
						$.each(data.products, function (i, obj)
						{
							autoSearchData.push({
								value: ACC.sanitizer.sanitize(obj.name),
								code: obj.code,
								desc: ACC.sanitizer.sanitize(obj.description),
								manufacturer: ACC.sanitizer.sanitize(obj.manufacturer),
								url:  ACC.config.encodedContextPath + obj.url,
								price: obj.price !== undefined && obj.price !== null ? obj.price.formattedValue : undefined,
								type: "productResult",
								image: (obj.images!=null && self.options.displayProductImages) ? obj.images[0].url : null // prevent errors if obj.images = null
							});
						});
					}

                    if (!autoSearchData.length) {
                        $(".search-product-not-found").show();
                    }

					self.options.cache[term] = autoSearchData;
					return response(autoSearchData);
				});
			}

		});


		$search = $(".js-site-search-input");
		if($search.length>0){
			$search.yautocomplete()
		}

	},

	bindDisableSearch: function ()
	{
		$('#js-site-search-input').keyup(function(){
			$('#js-site-search-input').val($('#js-site-search-input').val().replace(/^\s+/gm,''));
			$('.js_search_button').prop('disabled', this.value == "" ? true : false);
		})
	}
};
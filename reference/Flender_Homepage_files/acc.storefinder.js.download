ACC.storefinder = {

    _autoload: [
        ["init", $(".js-store-finder").length != 0],
        ["bindStoreChange", $(".js-store-finder").length != 0],
        ["bindSearch", $(".js-store-finder").length != 0],
        "bindPagination"
    ],

    storeData:"",
    storeId:"",
    coords:{},
    storeSearchData:{},
    maxListSize: 7,
    globalMap:{},
    markerCluster:{},

    createListItemHtml: function (data,id){

        var entryName = data.displayName;

        if(!entryName)
            entryName = data.name;

        var item="";
        item+='<li class="list__entry">';
        item+='<input type="radio" name="storeNamePost" value="'+entryName+'" id="store-filder-entry-'+id+'" class="js-store-finder-input" data-id="'+id+'">';
        item+='<label for="store-filder-entry-'+id+'" class="js-select-store-label">';
        item+='<span class="entry__info">';
        if (data.localAddress) {
            item+='<span class="entry__localAddress">'+data.localAddress+'</span>';
        } else {
            item+='<span class="entry__name">'+entryName+'</span>';
            item+='<span class="entry__address">'+data.line1+' '+data.line2+'</span>';
            item+='<span class="entry__city">'+ data.postalCode + ' ' +data.town+'</span>';
        }
        item+='</span>';
        item+='</label>';
        item+='</li>';
        return item;
    },

    refreshNavigation: function (){
        var listitems = "";
        data = ACC.storefinder.storeData;

        if(data){

            var nrOfListItems = data.total;

            if(nrOfListItems > ACC.storefinder.maxListSize)
                nrOfListItems = ACC.storefinder.maxListSize;

            for(i = 0; i < nrOfListItems; i++) {
                listitems += ACC.storefinder.createListItemHtml(data["data"][i],i)
            }

            $(".js-store-finder-navigation-list").html(listitems);

            // select the first store
            var firstInput= $(".js-store-finder-input")[0];
            $(firstInput).click();
        }


        var page = ACC.storefinder.storeSearchData.page;
        $(".js-store-finder-pager-item-from").html(page*10+1);

        var to = ((page*10+10)>ACC.storefinder.storeData.total)? ACC.storefinder.storeData.total : page*10+10 ;
        $(".js-store-finder-pager-item-to").html(to);
        $(".js-store-finder-pager-item-all").html(ACC.storefinder.storeData.total);
        $(".js-store-finder").removeClass("show-store");

    },


    bindPagination:function ()
    {



        $(document).on("click",".js-store-finder-details-back",function(e){
            e.preventDefault();

            $(".js-store-finder").removeClass("show-store");

        })




        $(document).on("click",".js-store-finder-pager-prev",function(e){
            e.preventDefault();
            var page = ACC.storefinder.storeSearchData.page;
            ACC.storefinder.getStoreData(page-1)
            checkStatus(page-1);
        })

        $(document).on("click",".js-store-finder-pager-next",function(e){
            e.preventDefault();
            var page = ACC.storefinder.storeSearchData.page;
            ACC.storefinder.getStoreData(page+1)
            checkStatus(page+1);
        })

        function checkStatus(page){
            if(page==0){
                $(".js-store-finder-pager-prev").attr("disabled","disabled")
            }else{
                $(".js-store-finder-pager-prev").removeAttr("disabled")
            }

            if(page == Math.floor(ACC.storefinder.storeData.total/10)){
                $(".js-store-finder-pager-next").attr("disabled","disabled")
            }else{
                $(".js-store-finder-pager-next").removeAttr("disabled")
            }
        }

    },


    bindStoreChange:function()
    {
        $(document).on("change",".js-store-finder-input",function(e){
            e.preventDefault();

            storeData=ACC.storefinder.storeData["data"];

            var storeId=$(this).data("id");

            var $ele = $(".js-store-finder-details");
            $ele.find(".text-tel").hide();

            if(storeData[storeId].localAddress) {
                $(".js-store-address-classicAddress").hide();
                $(".js-store-address-localAddress").show();
            } else {
                $(".js-store-address-classicAddress").show();
                $(".js-store-address-localAddress").hide();
            }

            $.each(storeData[storeId],function(key,value){
                if(key=="image"){
                    if(value!=""){
                        $ele.find(".js-store-image").html('<img src="'+value+'" alt="" />');
                    }else{
                        $ele.find(".js-store-image").html('');
                    }
                }
                else if(key=="email") {
                    $ele.find(".js-store-email").html('<a href="mailto:'+ value +'">' + value + '</a>');
                }
                else if(key=="url") {

                    $ele.find(".js-store-url").html('<a href="http://'+ value +'" target="_blank">' + value + '</a>');
                }
                else if(key=="phone") {

                    if(value != "")
                        $ele.find(".text-tel").show();

                    $ele.find(".js-store-phone").html(value);
                }
                else if(key=="content") {
                    $ele.find(".js-store-content").html(value);
                }
                /*else if(key=="productcode"){
					$ele.find(".js-store-productcode").val(value);
				}
				else if(key=="openings"){
					if(value!=""){
						var $oele = $ele.find(".js-store-"+key);
						var openings = "";
						$.each(value,function(key2,value2){
							openings += "<dt>"+key2+"</dt>";
							openings += "<dd>"+value2+"</dd>";
						});

						$oele.html(openings);

					}else{
						$ele.find(".js-store-"+key).html('');
					}

				}
				else if(key=="specialOpenings"){}
				else if(key=="features"){
					var features="";
					$.each(value,function(key2,value2){
						features += "<li>"+value2+"</li>";
					});

					$ele.find(".js-store-"+key).html(features);

                }*/
                else{
                    if(value!=""){
                        $ele.find(".js-store-"+key).html(value);
                    }else{
                        $ele.find(".js-store-"+key).html('');
                    }
                }

                if($ele.find("#routePlanningLink") && ACC.storefinder.coords.latitude != null && ACC.storefinder.coords.longitude != null) {
                    var start = ACC.storefinder.coords.latitude + ',' + ACC.storefinder.coords.longitude;
                    var destination = storeData[storeId]["latitude"] + ',' + storeData[storeId]["longitude"];
                    $ele.find("#routePlanningLink").attr('href', 'http://maps.google.com/maps?saddr=' + start + '&daddr=' + destination);
                }
            });

            ACC.storefinder.storeId = storeData[storeId];
            ACC.storefinder.initGoogleMap();

        })

        $(document).on("click",".js-select-store-label",function(e){
            $(".js-store-finder").addClass("show-store")
        })

        $(document).on("click",".js-back-to-storelist",function(e){
            $(".js-store-finder").removeClass("show-store")
        })

    },

    // intialize Google API and define callback to draw the map
    initGlobalMap: function() {

        if($("#globalMap").length > 0) {
            ACC.global.addGoogleMapsApi("ACC.storefinder.loadGlobalMap");
        }
    },

    // load and draw the global map
    loadGlobalMap: function() {

        // get div thats contains the map
        var globalMap = $("#globalMap");
        var locations = [];
        var markersArray = [];

        // set map parameters
        var mapOptions = {
            zoomControl: true,
            panControl: false,
            draggable: true,
            fullscreenControl: false,
            mapTypeControl: false,
            minZoom: 2,
            streetViewControl: false,
            //gestureHandling: 'greedy',
            mapTypeId: google.maps.MapTypeId.ROADMAP
        }


        // draw the map
        ACC.storefinder.globalMap = new google.maps.Map(document.getElementById("globalMap"), mapOptions);

        // set map style and apply it
        // --> remove dotted equator and dateline
        var mapStyle = [
            {
                featureType: "administrative",
                elementType: "geometry.fill",
                stylers: [
                    { visibility: "off" }
                ]
            }
        ];

        var styledMap = new google.maps.StyledMapType(mapStyle);
        ACC.storefinder.globalMap.mapTypes.set('myCustomMap', styledMap);
        ACC.storefinder.globalMap.setMapTypeId('myCustomMap');

        // resize map
        google.maps.event.addListenerOnce(ACC.storefinder.globalMap, 'idle', function(){
            ACC.storefinder.resizeGlobalMap(ACC.storefinder.globalMap);
        });
        // fallback if google maps event broken
        setTimeout(function(){
            if($('#globalMap').outerHeight()===0) ACC.storefinder.resizeGlobalMap(ACC.storefinder.globalMap);
        }, 500);

        // bind resize-function for resize-window event
        $(window).bind('resize', function(){ACC.storefinder.resizeGlobalMap(ACC.storefinder.globalMap)});

        // draw markers of all stores
        for(var i = 0; i < allStores.data.length; i++) {

            var curMarker = allStores.data[i];

            if(allStores.data[i].type==="STORE") {
                locations.push({lat: parseFloat(allStores.data[i].latitude), lng: parseFloat(allStores.data[i].longitude), icon: "/images/Sales.png"});
            }
            else if(allStores.data[i].type==="PLANT") {
                locations.push({lat: parseFloat(allStores.data[i].latitude), lng: parseFloat(allStores.data[i].longitude), icon: "/images/Production.png"});
            } else {
                locations.push({lat: parseFloat(allStores.data[i].latitude), lng: parseFloat(allStores.data[i].longitude), icon: "/images/Service.png"});
            }

            marker = new google.maps.Marker({
                position: new google.maps.LatLng(curMarker["latitude"],curMarker["longitude"]),
                map: ACC.storefinder.globalMap,
                icon: ACC.config.commonResourcePath + locations[i].icon
            });

            allStores.data[i].marker = marker;
            markersArray.push(marker);

            google.maps.event.addListener(marker, 'click', (function(marker, i) {
                return function() {
                    ACC.storefinder.getInitStoreData(null,marker.getPosition().lat(),marker.getPosition().lng());
                    $('html, body').animate({
                        scrollTop: $(".store__finder--panel").offset().top-200
                    }, 500);
                }
            })(marker, i));
        }


        // Add a marker clusterer to manage the markers.
        markerCluster = new MarkerClusterer(ACC.storefinder.globalMap, markersArray,
            {gridSize: 30, maxZoom: 15, imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});




        $("#cbService").change(function(e){
            markerCluster.clearMarkers();
            ACC.storefinder.refreshMarkers();
        });

        $("#cbSale").change(function(e){
            markerCluster.clearMarkers();
            ACC.storefinder.refreshMarkers();
        });

        $("#cbProduction").change(function(e){
            markerCluster.clearMarkers();
            ACC.storefinder.refreshMarkers();
        });

        if(navigator.geolocation){
            navigator.geolocation.getCurrentPosition(
                function (position){
                    ACC.storefinder.coords = position.coords;
                    //$('#findStoresNearMe').removeAttr("disabled");

                    ACC.storefinder.getInitStoreData(null,ACC.storefinder.coords.latitude,ACC.storefinder.coords.longitude);
                },
                function (error)
                {
                    console.log("An error occurred... The error code and message are: " + error.code + "/" + error.message);
                }
            );
        }
    },

    // resize the global map to current width
    resizeGlobalMap: function(map) {

        // static bounds to draw the global map
        var bounds = new google.maps.LatLngBounds();
        bounds.extend(new google.maps.LatLng(60,100));
        bounds.extend(new google.maps.LatLng(-30,-100));

        // get div which contains the map
        var globalMap = $("#globalMap");

        globalMap.css("width", "100%");
        globalMap.css("padding-bottom", globalMap.width() * 0.5 + 'px');

        // fit map to given bounds
        map.fitBounds(bounds);

        // set center of the map after 'fitBounds' is finished
        google.maps.event.addListenerOnce(map, 'bounds_changed', function(event) {
            map.setCenter(new google.maps.LatLng(20,10));
        });

        google.maps.event.trigger(map, 'resize');
    },

    initGoogleMap:function(){

        if($(".js-store-finder-map").length > 0){
            //ACC.global.addGoogleMapsApi("ACC.storefinder.loadGoogleMap");
            ACC.storefinder.loadGoogleMap();
        }
    },

    loadGoogleMap: function(){

        storeInformation = ACC.storefinder.storeId;

        if($(".js-store-finder-map").length > 0)
        {
            $(".js-store-finder-map").attr("id","store-finder-map")
            var centerPoint = new google.maps.LatLng(storeInformation["latitude"], storeInformation["longitude"]);

            var mapOptions = {
                zoom: 13,
                zoomControl: true,
                panControl: true,
                streetViewControl: false,
                fullscreenControl: false,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                center: centerPoint
            }

            var map = new google.maps.Map(document.getElementById("store-finder-map"), mapOptions);

            if(storeInformation.type==="STORE") {
                var icon = "/images/Sales.png"
            }
            else if(storeInformation.type==="PLANT") {
                var icon = "/images/Production.png"
            } else {
                var icon = "/images/Service.png"
            }

            var marker = new google.maps.Marker({
                position: new google.maps.LatLng(storeInformation["latitude"], storeInformation["longitude"]),
                map: map,
                title: storeInformation["name"],
                icon: ACC.config.commonResourcePath + icon
            });
            var infowindow = new google.maps.InfoWindow({
                content: storeInformation["name"],
                disableAutoPan: true
            });
            google.maps.event.addListener(marker, 'click', function (){
                infowindow.open(map, marker);
            });
        }

    },


    bindSearch:function(){

        $(document).on("submit",'#storeFinderForm', function(e){

            e.preventDefault()
            var q = $(".js-store-finder-search-input").val();

            if(q.length>0){
                ACC.storefinder.getInitStoreData(q);
            }else{
                if($(".js-storefinder-alert").length<1){
                    var emptySearchMessage = $("#storeSearchButton").data("searchEmpty");
                    $(".js-store-finder").hide();
                    $("#storeFinder").after('<div class="js-storefinder-alert alert alert-danger alert-dismissable getAccAlert" ><button class="close closeAccAlert" type="button" data-dismiss="alert" aria-hidden="true">×</button>' + emptySearchMessage + '</div>');
                    $(".closeAccAlert").on("click", function () {
                        $(this).parent('.getAccAlert').remove();
                    });

                    $("#storeFinder").after('<div class="js-storefinder-alert alert alert-danger alert-dismissable" ><button class="close" type="button" data-dismiss="alert" aria-hidden="true">×</button>' + emptySearchMessage + '</div>');
                }
            }
        })

        /*$(".js-store-finder").hide();
		$(document).on("click",'#findStoresNearMe', function(e){
			e.preventDefault()
			ACC.storefinder.getInitStoreData(null,ACC.storefinder.coords.latitude,ACC.storefinder.coords.longitude);
        })*/
    },


    getStoreData: function(page){
        ACC.storefinder.storeSearchData.page = page;
        url= $(".js-store-finder").data("url");

        // apply checkbox value to request (filter stores and pos)
        ACC.storefinder.storeSearchData.showService = $('#cbService').prop('checked');
        ACC.storefinder.storeSearchData.showSales = $('#cbSale').prop('checked');
        ACC.storefinder.storeSearchData.showProduction = $('#cbProduction').prop('checked');

        $.ajax({
            url: url,
            data: ACC.storefinder.storeSearchData,
            type: "get",
            success: function (response){
                ACC.storefinder.storeData = $.parseJSON(response);
                ACC.storefinder.refreshNavigation();

                if(ACC.storefinder.storeData.total == 0) {
                    var emptySearchMessage = $(".btn-primary").data("searchEmpty");
                    $("#storeFinder").after('<div class="js-storefinder-alert alert alert-danger alert-dismissable" ><button class="close" type="button" data-dismiss="alert" aria-hidden="true">×</button>' + emptySearchMessage + '</div>');
                    $(".js-store-finder").hide();
                }
                else {
                    $(".js-store-finder").show();
                }

                if(ACC.storefinder.storeData.total < 10){
                    $(".js-store-finder-pager-next").attr("disabled","disabled");
                }
            }
        });
    },

    getInitStoreData: function(q,latitude,longitude){
        $(".alert").remove();
        data ={
            "q":"" ,
            "page":0
        }
        if(q != null){
            data.q = q;
        }

        if(latitude != null){
            data.latitude = latitude;
        }

        if(longitude != null){
            data.longitude = longitude;
        }

        ACC.storefinder.storeSearchData = data;
        ACC.storefinder.getStoreData(data.page);
        $(".js-store-finder").show();
        $(".js-store-finder-pager-prev").attr("disabled","disabled")
        $(".js-store-finder-pager-next").removeAttr("disabled")
    },

    refreshMarkers:function() {
        var markersArray = [];

        if (!$("#cbService").is(":checked") && !$("#cbSale").is(":checked") && !$("#cbProduction").is(":checked")) {
            for(var i = 0; i < allStores.data.length; i++) {
                markersArray.push(allStores.data[i].marker);
            }
        }
        else if($("#cbService").is(":checked") && $("#cbSale").is(":checked") && $("#cbProduction").is(":checked")){
            for(var i = 0; i < allStores.data.length; i++) {
                markersArray.push(allStores.data[i].marker);
            }
        }
        else if($("#cbService").is(":checked") && !$("#cbSale").is(":checked") && !$("#cbProduction").is(":checked")){
            for(var i = 0; i < allStores.data.length; i++) {
                if(allStores.data[i].type == "POS") {
                    markersArray.push(allStores.data[i].marker);
                }
            }
        }
        else if(!$("#cbService").is(":checked") && $("#cbSale").is(":checked") && !$("#cbProduction").is(":checked")){
            for(var i = 0; i < allStores.data.length; i++) {
                if(allStores.data[i].type == "STORE") {
                    markersArray.push(allStores.data[i].marker);
                }
            }
        }
        else if(!$("#cbService").is(":checked") && !$("#cbSale").is(":checked") && $("#cbProduction").is(":checked")){
            for(var i = 0; i < allStores.data.length; i++) {
                if(allStores.data[i].type == "PLANT") {
                    markersArray.push(allStores.data[i].marker);
                }
            }
        }
        else if(!$("#cbService").is(":checked") && $("#cbSale").is(":checked") && $("#cbProduction").is(":checked")){
            for(var i = 0; i < allStores.data.length; i++) {
                if(allStores.data[i].type == "PLANT" || allStores.data[i].type == "STORE") {
                    markersArray.push(allStores.data[i].marker);
                }
            }
        }
        else if($("#cbService").is(":checked") && !$("#cbSale").is(":checked") && $("#cbProduction").is(":checked")){
            for(var i = 0; i < allStores.data.length; i++) {
                if(allStores.data[i].type == "PLANT" || allStores.data[i].type == "POS") {
                    markersArray.push(allStores.data[i].marker);
                }
            }
        }
        else if($("#cbService").is(":checked") && $("#cbSale").is(":checked") && !$("#cbProduction").is(":checked")){
            for(var i = 0; i < allStores.data.length; i++) {
                if(allStores.data[i].type == "STORE" || allStores.data[i].type == "POS") {
                    markersArray.push(allStores.data[i].marker);
                }
            }
        }
        // Add a marker clusterer to manage the markers.
        markerCluster = new MarkerClusterer(ACC.storefinder.globalMap, markersArray,
            {gridSize: 30, maxZoom: 15, imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});
    },

    init:function(){

        //$("#findStoresNearMe").attr("disabled","disabled");


        // draw the global map with markers of all stores
        ACC.storefinder.initGlobalMap();
    }
};

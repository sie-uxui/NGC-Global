ACC.global = {

    _autoload: [
        ["passwordStrength", $('.password-strength').length > 0],
        "bindToggleOffcanvas",
        "setLanguageFormSubmit",
        "bindToggleXsSearch",
        "bindHoverIntentMainNavigation",
        "searchBoxMobileDisplay",
        "initImager",
        "backToHome",
        "bindDropdown",
        "closeAccAlert"
    ],

    passwordStrength: function () {
        $('.password-strength').pstrength({
            verdicts: [ACC.pwdStrengthTooShortPwd,
                ACC.pwdStrengthVeryWeak,
                ACC.pwdStrengthWeak,
                ACC.pwdStrengthMedium,
                ACC.pwdStrengthStrong,
                ACC.pwdStrengthVeryStrong],
            minchar: 8,
            minCharText: ACC.pwdStrengthMinCharText
        });
    },

    setLanguageFormSubmit: function () {
        $(".lang-dropdown").on("click", function () {
          var lang = $(this).data("value");
          $('#lang-selector option[value="' + lang + '"]').prop('selected', true);

          if ($('#casconfiguration-frame').length) {
              const configUrlFormField = document.createElement('input');
              configUrlFormField.type = 'hidden';
              configUrlFormField.name = "configuratorUrl";
              configUrlFormField.value = $('#casconfiguration-frame').attr('src');
              $('#lang-form').append(configUrlFormField);
          }

          $('#lang-form').submit();
        });
    },

    bindToggleOffcanvas: function () {
        $(document).on("click", ".js-toggle-sm-navigation", function (e) {          
            ACC.global.toggleClassState($("main"), "offcanvas");
            ACC.global.toggleClassState($("html"), "offcanvas");
            ACC.global.toggleClassState($("body"), "offcanvas");
            ACC.global.resetXsSearch();
            e.stopPropagation();
            e.preventDefault();
        });
    },

    bindToggleXsSearch: function () {
        $(document).on("click", ".js-toggle-xs-search", function () {
            ACC.global.toggleClassState($(".site-search"), "active");
            ACC.global.toggleClassState($(".js-mainHeader .navigation--middle"), "search-open");
        });
    },

    resetXsSearch: function () {
        $('.site-search').removeClass('active');
        $(".js-mainHeader .navigation--middle").removeClass("search-open");
    },

    toggleClassState: function ($e, c) {
        $e.hasClass(c) ? $e.removeClass(c) : $e.addClass(c);
        return $e.hasClass(c);
    },

    bindHoverIntentMainNavigation: function () {

        //$('.js_nav__link').each(function() {
        //      if($(this).attr('data-children')) {
        //        $(this).attr('data-toggle', 'dropdown');
        //      }
        // });

         $('.dropdown-submenu').on("click", function(e){
                    

           if(e.target.tagName.toLowerCase() === 'a' && $(e.target).attr('class')===undefined && $(window).width() <= parseInt(screenSmMax)) {
               window.location.href = e.target.href;
               return;
           }

           // toggle submenu level 4
           if($(this).is('.submenu-4') && !$(e.target).parent().hasClass('submenu-empty')) {
            var submenu = $(this).children('.submenu');
            var openSubmenu = $('.sub-navigation-section-4').find('.submenu.open');                  

            submenu.toggle();
            submenu.addClass('open');

            openSubmenu.hide();
            openSubmenu.removeClass('open');

            e.stopPropagation();
            e.preventDefault();
                    }
          // toggle submenu level 3
          if($(this).is('.submenu-3') && !$(e.target).parent().hasClass('submenu-empty')) {

            var submenu = $(this).children('.submenu');
            var openSubmenu = $('.sub-navigation-section-3 li').find('.submenu.open');

            submenu.toggle();
            submenu.addClass('open');

            openSubmenu.hide();
            openSubmenu.removeClass('open');

            e.stopPropagation();
            e.preventDefault();
          }

                });
      
            },

    searchBoxMobileDisplay: function () {
  
        /*
        enquire.register("screen and (max-width:768px)", {

            match: function () {
              $(".fl-search").appendTo(".fl-search__mobile");
            },

            unmatch: function () {
              $(".fl-search").appendTo(".fl-search__desktop");
            }

        });
        */
    },

    initImager: function (elems) {
        elems = elems || '.js-responsive-image';
        this.imgr = new Imager(elems);
    },

    reprocessImages: function (elems) {
        elems = elems || '.js-responsive-image';
        if (this.imgr == undefined) {
            this.initImager(elems);
        } else {
            this.imgr.checkImagesNeedReplacing($(elems));
        }
    },

    // usage: ACC.global.addGoogleMapsApi("callback function"); // callback function name like "ACC.global.myfunction"
    addGoogleMapsApi: function (callback) {
        var script = '<script class="js-googleMapsApi" type="text/javascript" src="//maps.googleapis.com/maps/api/js?key=' + ACC.config.googleApiKey + '&callback=' + callback;

        if (ACC.config.language != undefined) {
            script += '&language=' + ACC.config.language;
        }
        script += '"></script>';
        $('head').append(script);
    },

    backToHome: function () {
        $(".backToHome").on("click", function () {
            var sUrl = ACC.config.contextPath;
            window.location = sUrl;
        });
    },

    setupDatePicker: function (visibleInputField) {

        var lang = visibleInputField.data('language');
        var regional = $.datepicker.regional[lang];
        if (regional === undefined) {
            regional = $.datepicker.regional['en'];
        }

        var valueInputFieldId = visibleInputField.data('valueInputFieldId');
        
        var valueInputField = $('#' + valueInputFieldId);
        if (valueInputField.attr('value')) {
        	var date = $.datepicker.parseDate("yy-mm-dd", valueInputField.attr('value'));
        	visibleInputField.attr('value', $.datepicker.formatDate(regional.dateFormat, date));
        }
        
        $.datepicker.setDefaults(regional);
        visibleInputField.datepicker({
        	minDate: visibleInputField.data('minDate'),
        	maxDate: visibleInputField.data('maxDate'),
        	altField: '#' + valueInputFieldId,
        	altFormat: 'yy-mm-dd'
        });
    },
    
    bindDropdown: function() {
    	//$(document).on("click", ".dropdown-toggle", dropdownToggle);
    },

    closeAccAlert: function () {
        $(".closeAccAlert").on("click", function () {
            $(this).parent('.getAccAlert').remove();
        });
    }

};
// ***** Dropdown begins *****
function dropdownParent($this) {
    var selector = $this.attr('href')
    selector = selector && /#[A-Za-z]/.test(selector) && selector.replace(/.*(?=#[^\s]*$)/, '') // strip for ie7

    var $parent = selector && $(selector)

    return $parent && $parent.length ? $parent : $this.parent()
  };

function dropdownClearMenus(e) {
	// if right click, exit
    if (e && e.which === 3) return
    
    // remove class added on dropdownToggle
    $('.dropdown-backdrop').remove()
    
    $(".dropdown-toggle").each(function () {
      var $parent       = dropdownParent($(this))
      var relatedTarget = { relatedTarget: this }

      if (!$parent.hasClass('open')) return

      if (e && e.type == 'click' && /input|textarea/i.test(e.target.tagName) && $.contains($parent[0], e.target)) return

      $parent.removeClass('open')
    })
  };

 function dropdownToggle(e) {
	var $this = $(this)

    if ($this.is('.disabled, :disabled')) return

    var $parent  = dropdownParent($this)
    var isActive = $parent.hasClass('open')

    dropdownClearMenus()

    if (!isActive) {
      if ('ontouchstart' in document.documentElement && !$parent.closest('.navbar-nav').length) {
        // if mobile we use a backdrop because click events don't delegate
        $(document.createElement('div'))
          .addClass('dropdown-backdrop')
          .insertAfter($(this))
          .on('click', dropdownClearMenus)
      }

      var relatedTarget = { relatedTarget: this }

      if (e.isDefaultPrevented()) return

      // expand the <ul> on the dropdown
      $this
        .trigger('focus')
        .attr('aria-expanded', 'true')

      // set parent to open
      $parent.toggleClass('open')
    }

    return false
};
//***** Dropdown ends *****

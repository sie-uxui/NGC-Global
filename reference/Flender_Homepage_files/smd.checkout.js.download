ACC.checkout = {

    _autoload: [
        "bindCheckO",
        "bindForms",
        "bindPreferredDeliveryDate",
        "bindSavedPayments"
    ],


    bindForms: function () {

        $(document).on("click", "#addressSubmit", function (e) {
            e.preventDefault();
            var form = $("#addressForm"),
                valid = form[0].checkValidity();

            if (valid) {
                $('#addressForm').submit();
            } else {
                form[0].reportValidity()
            }
        })

        $(document).on("click", "#deliveryMethodSubmit", function (e) {
            e.preventDefault();
            $('#selectDeliveryMethodForm').submit();
        })

    },

    bindPreferredDeliveryDate: function (data) {
        var item = $('.js-preferredDeliveryDate');
        item.each(function () {
            ACC.global.setupDatePicker($(this));
        });


    },

    bindSavedPayments: function () {
        $(document).on("click", ".js-saved-payments", function (e) {
            e.preventDefault();

            var title = $("#savedpaymentstitle").html();

            $.colorbox({
                href: "#savedpaymentsbody",
                inline: true,
                maxWidth: "100%",
                opacity: 0.7,
                //width:"320px",
                title: title,
                close: '<span class="glyphicon glyphicon-remove"></span>',
                onComplete: function () {
                }
            });
        })
    },

    bindCheckO: function () {
        var cartEntriesError = false;

        // Alternative checkout flows options
        $('.doFlowSelectedChange').change(function () {
            if ('multistep-pci' == $('#selectAltCheckoutFlow').val()) {
                $('#selectPciOption').show();
            } else {
                $('#selectPciOption').hide();

            }
        });


        $('.js-continue-shopping-button').click(function () {
            var checkoutUrl = $(this).data("continueShoppingUrl");
            window.location = checkoutUrl;
        });

        $('.js-request-quote-button').click(function () {
            var checkoutUrl = $(this).data("continueShoppingUrl");
            window.location = checkoutUrl;
        });

        $('.js-create-quote-button').click(function () {
            $(this).prop("disabled", true);
            var createQuoteUrl = $(this).data("createQuoteUrl");
            window.location = createQuoteUrl;
        });


        $('.expressCheckoutButton').click(function () {
            document.getElementById("expressCheckoutCheckbox").checked = true;
        });

        $(document).on("input", ".confirmGuestEmail,.guestEmail", function () {

            var orginalEmail = $(".guestEmail").val();
            var confirmationEmail = $(".confirmGuestEmail").val();

            if (orginalEmail === confirmationEmail) {
                $(".guestCheckoutBtn").removeAttr("disabled");
            } else {
                $(".guestCheckoutBtn").attr("disabled", "disabled");
            }
        });

        $('.js-continue-checkout-button').click(function () {
                var checkoutUrl = $(this).data("checkout-url");

                cartEntriesError = ACC.pickupinstore.validatePickupinStoreCartEntires();
                if (!cartEntriesError) {
                    var expressCheckoutObject = $('.express-checkout-checkbox');
                    if (expressCheckoutObject.is(":checked")) {
                        window.location = expressCheckoutObject.data("expressCheckoutUrl");
                    } else {
                        var flow = $('#selectAltCheckoutFlow').val();
                        if (flow == undefined || flow == '' || flow == 'select-checkout') {
                            // No alternate flow specified, fallback to default behaviour
                            var $cartForm = $("#smdCartForm"),
                                submitCb = function() {
                                    $(".js-continue-checkout-button").prop("disabled", "disabled");
                                    $cartForm.submit();
                                };
                            if (checkoutUrl && checkoutUrl.length) {
                                $cartForm.attr('action', checkoutUrl);
                            }
                            ACC.checkout._handleCustomTextFields(submitCb);
                        } else {
                            // Fix multistep-pci flow
                            if ('multistep-pci' == flow) {
                                flow = 'multistep';
                            }
                            var pci = $('#selectPciOption').val();

                            // Build up the redirect URL
                            var redirectUrl = checkoutUrl + '/select-flow?flow=' + flow + '&pci=' + pci;
                            window.location = redirectUrl;
                        }
                    }
                }
                return false;
            }
        )
        ;
    },

    _handleCustomTextFields: function(cb) {
        var $customTextInputFieldsRequired = $(".custom-text-input--required"),
            $customTextInputFieldsValidation = true;

        $($customTextInputFieldsRequired).each(function () {
            if ($(this).val() === "") {
                $(this).css("background-color", "#f6e0e0");
                $customTextInputFieldsValidation = false;
                return false;
            }

            $(this).css("background-color", "#fff");
            $customTextInputFieldsValidation = true;
        });

        if ($customTextInputFieldsValidation === true) {
            var $customTextInputFieldsIndex = $(".custom-text-input--index");

            if ($customTextInputFieldsIndex.length) {
                $($customTextInputFieldsIndex).each(function (index) {
                    var $cartForm = $("#smdCartForm"),
                        $cartEntry = $(this).closest(".custom-text");

                    $($cartEntry).find("input").each(function () {
                        $(this).attr('name', $(this).attr('name').replace('index', index));
                        $(this).clone().attr('type', 'hidden').appendTo($cartForm)
                    });
                }).promise().done(function () {
                    cb && cb();
                });
            } else {
                cb && cb();
            }
        }
    }
}

